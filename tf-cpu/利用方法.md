# TensorflowのDockerイメージをPython2.7 → 3.5へ更新する方法

* ダウンロード元
<https://github.com/tensorflow/tensorflow>

* tensorflow/tensorflow/tools/docker/配下を作業用ディレクトリへコピー(例: ~/docker/tf-gpu)
* 作業用フォルダ内のDockerfileを編集する。
```
# Pick up some TF dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        libfreetype6-dev \
        libpng12-dev \
        libzmq3-dev \
        pkg-config \
        python3 \
        python3-dev \
        rsync \
        software-properties-common \
        unzip \
        git \  # ←追加
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN curl -O https://bootstrap.pypa.io/get-pip.py && \
    python3 get-pip.py && \
    rm get-pip.py

RUN pip3 --no-cache-dir install \
        ipykernel \
        jupyter \
        matplotlib \
        numpy \
        scipy \
        sklearn \
        pandas \
        Pillow \
        && \
    python3 -m ipykernel.kernelspec


# Install TensorFlow GPU version.
RUN pip3 --no-cache-dir install \
    https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-0.12.1-cp35-cp35m-linux_x86_64.whl  # ←URL & Tensorflowのバージョン変更(0.10.0 → 0.12.1) 0.12.1でないと、CUDA-8.0に対応できない。

# Set up our notebook config.
COPY jupyter_notebook_config.py /root/.jupyter/

# Copy sample notebooks.
# COPY notebooks /notebooks  # ←削除

# Jupyter has issues with being run directly:
#   https://github.com/ipython/ipython/issues/7062
# We just add a little wrapper script.
COPY run_jupyter.sh /
RUN chmod +x /run_jupyter.sh  # ←追加
```
* jupyter_notebook_config.pyを編集する。

```
c.NotebookApp.allow_origin = '*'  # ←追加(CORS対応)
c.MultiKernelManager.default_kernel_name = 'python3'  # python2→python3に変更
```

* SSH接続
```
ssh -i key-pairs/sandbox.pem -p 443 ubuntu@fxss-ml-test-ssh-1699509335.ap-northeast-1.elb.amazonaws.com
```

* 作業用ディレクトリへ移動(例: cd ~/docker/tf-gpu)

* Dockerイメージ作成
```
nvidia-docker build --tag="29koji/tf-gpu" .
nvidia-docker build -t 29koji/tf-sample -f Dockerfile.gpu .
```

* イメージ作成確認
```
$ docker images
REPOSITORY              TAG                            IMAGE ID            CREATED              SIZE
29koji/tf-gpu           latest                         7d8c2ded2eec        About a minute ago   2.774 GB
nvidia/cuda             8.0-cudnn5-devel-ubuntu16.04   6984c781b17e        2 weeks ago          1.787 GB
```

* Dockerコンテナ作成&実行
```
nvidia-docker run -d --name tf-gpu -p 8888:8888 -p 6006:6006 -v ~/docker/tf-gpu/data/notebooks:/notebooks -e PASSWORD=pass 29koji/tf-gpu
nvidia-docker run -it -p 8888:8888 -p 6006:6006 -e PASSWORD=pass 29koji/tf-sample
nvidia-docker run -it -p 8888:8888 -p 6006:6006 -e PASSWORD=pass gcr.io/tensorflow/tensorflow:0.12.1-gpu
```

* Dockerコンテナ作成確認
```
docker ps -a
CONTAINER ID  IMAGE  …
b5bd48d309c6  29koji/tf-gpu  …
```

* Dockerコンテナ停止
```
docker stop tf-gpu
```

* Dockerコンテナ再開
```
docker start tf-gpu
```

* python version確認
IN:  import platform
     platform.python_version_tuple()
OUT: ('3', '4', '3')

* サンプルコードダウンロード
  * jupyter上でgithubからサンプルコードをクローンする。
```
!git clone https://github.com/koji77/jupyter_tensorflow.git
# オリジナル
# !git clone https://github.com/enakai00/jupyter_tfbook
```

* サンプルコード修正
  * jupyter notebook上でMatplitlibのグラフを表示するために必要なコード
  * print文の文法変更対応
``` py
import tensorflow as tf
import numpy as np
import matplotlib.pyplot as plt

# jupyter notebook上にグラフを表示するために必要
%matplotlib inline  # 追加

# print w_val  # python2.7
print (w_val)  # python3

# import cPickle as pickle  # python2.7
import _pickle as pickle  # python3.x

with open('ORENIST.data', 'rb') as file:
    #  images, labels = pickle.load(file)  # python2.7
    images, labels = pickle.load(file, encoding='latin1')  # python3.x

# Python３では、普通に「/」を用いて除算すると、整数同士でもfloatになる。
# 例
x = 6 / 2
print x  # 3.0

# これを避けるには、「/」ではなく「//」を用いる。
y = 6 // 2
print y # 3
```

* Tensorflow0.12.1の場合、Worningがでるので、次のコードは警告のとおりに修正する。
```
# sess.run(tf.initialize_all_variables())  # ← 0.10.0
# sess.run(tf.global_variables_initializer())  # ← 0.12.1
```
